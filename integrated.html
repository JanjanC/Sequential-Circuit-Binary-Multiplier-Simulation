<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous"
        />
        <script>
            //Convert to unsigned binary 2's complement
            function get2sComplement(bin) {
                let complement = "";
                let seenOne = false;

                for (let i = bin.length - 1; i >= 0; i--) {
                    if (!seenOne) {
                        if (bin[i] === "1") {
                            seenOne = true;
                        }
                        complement = bin[i] + complement;
                    } else {
                        if (bin[i] === "0") {
                            complement = 1 + complement;
                        } else {
                            complement = 0 + complement;
                        }
                    }
                }
                return complement;
            }

            function decToSignedBin(dec) {
                dec = parseInt(dec);
                if (dec >= 0) {
                    return "0" + dec.toString(2);
                } else {
                    let temp = "0" + (-dec).toString(2);
                    return get2sComplement(temp);
                }
            }

            function addBin(bin1, bin2) {
                let dec1 = 0;
                let dec2 = 0;

                if (bin1.charAt(0) == "1")
                    dec1 = -parseInt(2, get2sComplement(bin1));
                else dec1 = parseInt(2, bin1);

                if (bin2.charAt(0) == "1")
                    dec2 = -parseInt(2, get2sComplement(bin2));
                else dec2 = parseInt(2, bin2);

                return decToSignedBin(dec1 + dec2);

                /* Way faster version
    let carryOver = 0;
    let answer = "";
    bin1.forEach(function (value, index) {
        carryOver = carryOver + parseInt(value) + parseInt(bin2.charAt(index));
        answer = (carryOver % 10) + answer;
        carryOver = parseInt(carryOver / 10);
    });
    return answer;
    */
            }

            //Function for each iteration
            function sequentialCircuitBinaryMultiply(dec1, dec2) {
                let A = ""; //Answer
                let Qsub1 = ""; //Quotient Sub 1 from Arithmetic Shift Right
                let M = decToSignedBin(dec1); //Multiplicand
                let Mcomplement = decToSignedBin(-dec1); //Multiplicand
                let Q = decToSignedBin(dec2); //Multiplier
                let length = M.length > Q.length ? M.length : Q.length;

                // Make sure they are all the same length
                M.padStart(length, M.charAt(0));
                A.padStart(length, Q.charAt(0));
                Mcomplement.padStart(length, Mcomplement.charAt(0));

                const iterations = [];

                for (let i = 0; i < length; i++) {
                    let values = {};

                    if (Q % 10 == 0 && Qsub1 == 1) A = addBin(A, M);
                    else if (Q % 10 == 1 && Qsub1 == 0)
                        A = addBin(A, Mcomplement);

                    // Qsub1 gets the value of Q0 (the least significant bit of Q)
                    Qsub1 = Q.charAt(Q.length - 1);
                    // Q gets the least significant bit of A concatenated with Q minus the last character
                    Q = A.charAt(A.length - 1) + Q.slice(0, -1);
                    // A gets the most significant value of A concatenated with A minus the last character
                    A = A.charAt(0) + A.slice(0, -1);

                    values.A = A;
                    values.Q = Q;
                    values.Qsub1 = Qsub1;
                    values.M = M;
                    iterations.push(values);
                    console.log(values);
                }
                return iterations;
            }

            function submit() {
                let num1 = document.getElementById("num1").value;
                let num2 = document.getElementById("num2").value;
                let iterations = sequentialCircuitBinaryMultiply(num1, num2);
                console.log(iterations);
                let table = document.getElementById("answer");
                while (table.firstChild) table.removeChild(table.firstChild);

                let headerRow = document.createElement("tr");
                let header1 = document.createElement("th");
                header1.appendChild(document.createTextNode("A"));
                let header2 = document.createElement("th");
                header2.appendChild(document.createTextNode("Q"));
                let header3 = document.createElement("th");
                header3.appendChild(document.createTextNode("Q -1"));
                headerRow.appendChild(header1);
                headerRow.appendChild(header2);
                headerRow.appendChild(header3);
                table.appendChild(headerRow);

                for (const i of iterations) {
                    let row = document.createElement("tr");
                    let aData = document.createElement("td");
                    let qData = document.createElement("td");
                    let qSub1Data = document.createElement("td");
                    aData.appendChild(document.createTextNode(i.A));
                    qData.appendChild(document.createTextNode(i.Q));
                    qSub1Data.appendChild(document.createTextNode(i.Qsub1));
                    row.appendChild(aData);
                    row.appendChild(qData);
                    row.appendChild(qSub1Data);
                    table.appendChild(row);
                }
            }

            function outputToText() {
                // FS module is required for it contains the definition of the writefile function
                const fs = require("fs"); /*fs.writeFile('output.txt', , (err) => {

                })*/
            }
        </script>
        <title>Document</title>
    </head>
    <body>
        <div class="form-group">
            <label for="num1">Num 1</label>
            <input
                type="text"
                class="form-control"
                id="num1"
                pattern="[0-9]+"
                title="0 - 9 Only"
            />
        </div>
        <div class="form-group">
            <label for="num2">Num 2</label>
            <input
                type="text"
                class="form-control"
                id="num2"
                pattern="[0-9]+"
                title="0 - 9 Only"
            />
        </div>
        <button onclick="submit()">Compute</button>
        <table id="answer"></table>
    </body>
</html>
